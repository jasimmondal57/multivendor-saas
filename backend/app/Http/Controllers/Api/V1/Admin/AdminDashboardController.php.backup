<?php

namespace App\Http\Controllers\Api\V1\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use App\Models\Vendor;
use App\Models\Product;
use App\Models\Order;
use App\Models\OrderItem;
use App\Models\ProductReview;
use App\Models\Coupon;
use App\Models\VendorOnboardingStep;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class AdminDashboardController extends Controller
{
    /**
     * Get admin dashboard statistics
     */
    public function stats(Request $request)
    {
        $stats = [
            'total_vendors' => Vendor::where('status', 'active')->count(),
            'total_customers' => User::where('user_type', 'customer')->count(),
            'total_orders' => Order::count(),
            'total_revenue' => OrderItem::sum('total_price') ?? 0,
            'pending_vendors' => VendorOnboardingStep::where('verification_status', 'in_review')->count(),
            'pending_products' => Product::where('approval_status', 'pending')->count(),
            'total_products' => Product::count(),
            'total_reviews' => ProductReview::count(),
            'active_coupons' => Coupon::where('is_active', true)
                ->where('valid_from', '<=', now())
                ->where('valid_until', '>=', now())
                ->count(),
        ];

        return response()->json([
            'success' => true,
            'data' => $stats,
        ]);
    }

    /**
     * Get all vendors
     */
    public function vendors(Request $request)
    {
        $query = Vendor::with(['user']);

        // Filter by status
        if ($request->has('status')) {
            if ($request->status === 'pending') {
                // Pending approval - verification_status is pending
                $query->where('verification_status', 'pending');
            } elseif ($request->status === 'rejected') {
                // Rejected - verification_status is rejected
                $query->where('verification_status', 'rejected');
            } else {
                // Active, inactive, suspended
                $query->where('status', $request->status);
            }
        }

        // Search
        if ($request->has('search')) {
            $query->whereHas('user', function ($q) use ($request) {
                $q->where('name', 'like', '%' . $request->search . '%')
                  ->orWhere('email', 'like', '%' . $request->search . '%');
            })->orWhere('business_name', 'like', '%' . $request->search . '%');
        }

        $vendors = $query->orderBy('created_at', 'desc')->paginate(20);

        return response()->json([
            'success' => true,
            'data' => $vendors,
        ]);
    }

    /**
     * Update vendor status
     */
    public function updateVendorStatus(Request $request, $vendorId)
    {
        $request->validate([
            'status' => 'required|in:active,inactive,suspended',
        ]);

        $vendor = Vendor::with('products')->findOrFail($vendorId);

        $updateData = ['status' => $request->status];

        // Clear suspension data if activating
        if ($request->status === 'active') {
            $updateData['suspension_reason'] = null;
            $updateData['suspended_at'] = null;
            $updateData['suspended_by'] = null;

            // Restore product availability
            foreach ($vendor->products as $product) {
                if ($product->unavailability_reason && 
                    (str_contains($product->unavailability_reason, 'Vendor suspended') ||
                     str_contains($product->unavailability_reason, 'Vendor temporarily inactive'))) {
                    $product->restoreAvailability();
                }
            }
        } elseif ($request->status === 'inactive') {
            // Mark products as temporarily unavailable
            foreach ($vendor->products as $product) {
                if ($product->stock_status !== 'out_of_stock' && empty($product->unavailability_reason)) {
                    $product->markAsTemporarilyUnavailable('Vendor temporarily inactive');
                }
            }
        }

        $vendor->update($updateData);

        return response()->json([
            'success' => true,
            'message' => 'Vendor status updated successfully',
        ]);
    }

    /**
     * Suspend vendor
     */
    public function suspendVendor(Request $request, $vendorId)
    {
        $request->validate([
            'reason' => 'required|string|max:500',
        ]);

        $vendor = Vendor::with('products')->findOrFail($vendorId);
        $vendor->update([
            'status' => 'suspended',
            'suspension_reason' => $request->reason,
            'suspended_at' => now(),
            'suspended_by' => $request->user()->id,
        ]);

        // Mark all vendor products as temporarily unavailable
        foreach ($vendor->products as $product) {
            if ($product->stock_status !== 'out_of_stock' && empty($product->unavailability_reason)) {
                $product->markAsTemporarilyUnavailable('Vendor suspended: ' . $request->reason);
            }
        }

        return response()->json([
            'success' => true,
            'message' => 'Vendor suspended successfully',
        ]);
    }

    /**
     * Get all products
     */
    public function products(Request $request)
    {
        $query = Product::with(['category', 'vendor.user']);

        // Filter by approval status
        if ($request->has('approval_status')) {
            $query->where('approval_status', $request->approval_status);
        }

        // Search
        if ($request->has('search')) {
            $query->where('name', 'like', '%' . $request->search . '%');
        }

        $products = $query->orderBy('created_at', 'desc')->paginate(20);

        return response()->json([
            'success' => true,
            'data' => $products,
        ]);
    }

    /**
     * Approve product
     */
    public function approveProduct($productId)
    {
        $product = Product::findOrFail($productId);
        $product->update(['approval_status' => 'approved']);

        return response()->json([
            'success' => true,
            'message' => 'Product approved successfully',
        ]);
    }

    /**
     * Reject product
     */
    public function rejectProduct(Request $request, $productId)
    {
        $product = Product::findOrFail($productId);
        $product->update([
            'approval_status' => 'rejected',
            'rejection_reason' => $request->reason ?? 'Not specified',
        ]);

        return response()->json([
            'success' => true,
            'message' => 'Product rejected successfully',
        ]);
    }

    /**
     * Get all orders
     */
    public function orders(Request $request)
    {
        $query = Order::with(['customer', 'items.product', 'items.vendor']);

        // Filter by status
        if ($request->has('status')) {
            $query->where('status', $request->status);
        }

        // Search
        if ($request->has('search')) {
            $query->where('order_number', 'like', '%' . $request->search . '%')
                  ->orWhereHas('customer', function ($q) use ($request) {
                      $q->where('name', 'like', '%' . $request->search . '%');
                  });
        }

        $orders = $query->orderBy('created_at', 'desc')->paginate(20);

        return response()->json([
            'success' => true,
            'data' => $orders,
        ]);
    }

    /**
     * Get all customers
     */
    public function customers(Request $request)
    {
        $query = User::where('user_type', 'customer');

        // Filter by status
        if ($request->has('status')) {
            $query->where('status', $request->status);
        }

        // Search
        if ($request->has('search')) {
            $query->where('name', 'like', '%' . $request->search . '%')
                  ->orWhere('email', 'like', '%' . $request->search . '%');
        }

        $customers = $query->orderBy('created_at', 'desc')->paginate(20);

        return response()->json([
            'success' => true,
            'data' => $customers,
        ]);
    }

    /**
     * Update user status
     */
    public function updateUserStatus(Request $request, $userId)
    {
        $request->validate([
            'action' => 'required|in:activate,deactivate,ban,unban',
        ]);

        $user = User::findOrFail($userId);

        switch ($request->action) {
            case 'activate':
                $user->update(['status' => 'active']);
                break;
            case 'deactivate':
                $user->update(['status' => 'inactive']);
                break;
            case 'ban':
                $user->update(['status' => 'banned']);
                break;
            case 'unban':
                $user->update(['status' => 'active']);
                break;
        }

        return response()->json([
            'success' => true,
            'message' => 'User status updated successfully',
        ]);
    }

    /**
     * Get all reviews
     */
    public function reviews(Request $request)
    {
        $query = ProductReview::with(['user', 'product', 'vendor']);

        // Filter by rating
        if ($request->has('rating')) {
            $query->where('rating', $request->rating);
        }

        // Search
        if ($request->has('search')) {
            $query->where('review', 'like', '%' . $request->search . '%');
        }

        $reviews = $query->orderBy('created_at', 'desc')->paginate(20);

        return response()->json([
            'success' => true,
            'data' => $reviews,
        ]);
    }

    /**
     * Get all coupons
     */
    public function coupons(Request $request)
    {
        $query = Coupon::query();

        // Filter by status
        if ($request->has('status')) {
            if ($request->status === 'active') {
                $query->where('is_active', true)
                      ->where('valid_from', '<=', now())
                      ->where('valid_until', '>=', now());
            } elseif ($request->status === 'inactive') {
                $query->where('is_active', false);
            } elseif ($request->status === 'expired') {
                $query->where('valid_until', '<', now());
            }
        }

        $coupons = $query->orderBy('created_at', 'desc')->paginate(20);

        return response()->json([
            'success' => true,
            'data' => $coupons,
        ]);
    }

    /**
     * Get payment statistics
     */
    public function payments(Request $request)
    {
        $stats = [
            'total_payments' => DB::table('payments')->count(),
            'total_amount' => DB::table('payments')->where('status', 'completed')->sum('amount'),
            'pending_payments' => DB::table('payments')->where('status', 'pending')->count(),
            'failed_payments' => DB::table('payments')->where('status', 'failed')->count(),
            'cod_orders' => Order::where('payment_method', 'cod')->count(),
            'online_orders' => Order::where('payment_method', 'razorpay')->count(),
        ];

        $recentPayments = DB::table('payments')
            ->join('orders', 'payments.order_id', '=', 'orders.id')
            ->join('users', 'orders.customer_id', '=', 'users.id')
            ->select('payments.*', 'orders.order_number', 'users.name as customer_name')
            ->orderBy('payments.created_at', 'desc')
            ->limit(20)
            ->get();

        return response()->json([
            'success' => true,
            'data' => [
                'stats' => $stats,
                'recent_payments' => $recentPayments,
            ],
        ]);
    }

    /**
     * Get analytics data
     */
    public function analytics(Request $request)
    {
        $period = $request->get('period', '30'); // days

        // Revenue over time
        $revenueData = OrderItem::select(
            DB::raw('DATE(created_at) as date'),
            DB::raw('SUM(total_price) as revenue'),
            DB::raw('COUNT(DISTINCT order_id) as orders')
        )
        ->where('created_at', '>=', now()->subDays($period))
        ->groupBy('date')
        ->orderBy('date', 'asc')
        ->get();

        // Top products
        $topProducts = Product::select('products.*', DB::raw('COUNT(order_items.id) as sales_count'))
            ->join('order_items', 'products.id', '=', 'order_items.product_id')
            ->groupBy('products.id')
            ->orderBy('sales_count', 'desc')
            ->limit(10)
            ->get();

        // Top vendors
        $topVendors = Vendor::select('vendors.*', DB::raw('SUM(order_items.total_price) as total_revenue'))
            ->join('order_items', 'vendors.id', '=', 'order_items.vendor_id')
            ->join('users', 'vendors.user_id', '=', 'users.id')
            ->groupBy('vendors.id')
            ->orderBy('total_revenue', 'desc')
            ->limit(10)
            ->with('user')
            ->get();

        return response()->json([
            'success' => true,
            'data' => [
                'revenue_chart' => $revenueData,
                'top_products' => $topProducts,
                'top_vendors' => $topVendors,
            ],
        ]);
    }

    /**
     * Get reports
     */
    public function reports(Request $request)
    {
        $type = $request->get('type', 'sales');
        $startDate = $request->get('start_date', now()->subDays(30));
        $endDate = $request->get('end_date', now());

        if ($type === 'sales') {
            $data = Order::whereBetween('created_at', [$startDate, $endDate])
                ->with(['customer', 'items'])
                ->get();
        } elseif ($type === 'revenue') {
            $data = OrderItem::whereBetween('created_at', [$startDate, $endDate])
                ->select(
                    DB::raw('DATE(created_at) as date'),
                    DB::raw('SUM(total_price) as revenue')
                )
                ->groupBy('date')
                ->get();
        } elseif ($type === 'vendors') {
            $data = Vendor::with(['user', 'store'])
                ->withCount('products')
                ->get();
        }

        return response()->json([
            'success' => true,
            'data' => $data ?? [],
        ]);
    }
}

